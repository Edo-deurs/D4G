const xhr=new XMLHttpRequest;var tabVal={};xhr.open("GET","./assets/json/referentiel-general-ecoconception-version-v1.json"),xhr.onload=function(){if(200===xhr.status){let e=JSON.parse(xhr.responseText),t=document.createElement("table"),n=document.createElement("thead"),l=document.createElement("tbody"),a=document.getElementById("theme-filter"),r=document.getElementById("state-filter"),o=["conforme","en cours de d\xe9ploiement","non conforme","non applicable","a definir",],d={};function i(e,t){console.log("here");let n=c();n[e]=t,localStorage.setItem("etats",JSON.stringify(n)),d=n,m()}function c(){let e=localStorage.getItem("etats");return e?JSON.parse(e):{}}d=c()||{},console.log("Initialized etats:",d),m();let s=document.getElementById("clear-localstorage");function m(){let t=document.getElementById("conforme-counter"),n=document.getElementById("en-cours-counter"),l=document.getElementById("non-conforme-counter"),a=document.getElementById("non-applicable-counter"),r=document.getElementById("a-definir-counter"),o=document.getElementById("conformity-score"),d=c()||{};console.log("etats in updateCounters:",d);let i=Object.values(d).reduce((e,t)=>(e[t]=(e[t]||0)+1,e),{});t.textContent=i.conforme||0,n.textContent=i["en cours de d\xe9ploiement"]||0,l.textContent=i["non conforme"]||0,a.textContent=i["non applicable"]||0,o.textContent=i["score de conformit\xe9"]||0;let s=e.criteres.length,m=Object.values(d).filter(e=>"a definir"!==e).length;r.textContent=s-m;let p=(i.conforme||0)/(s-(i["non applicable"]||0));return o.textContent=100*p.toFixed(2)+"%",o.textContent}function p(){let t=c()||{};l.innerHTML="",e.criteres.forEach(e=>{let n=document.createElement("tr"),a=document.createElement("td");a.textContent=e.thematique,n.appendChild(a);let r=document.createElement("td");r.textContent=e.critere,n.appendChild(r);let c=document.createElement("td"),s=document.createElement("select");s.name=`select-${e.id}`,o.forEach(e=>{let t=document.createElement("option");t.value=e,t.textContent=e,s.appendChild(t)}),s.critereId=e.id,s.value=t[e.id]||"a definir",s.addEventListener("change",t=>{d[e.id]=t.target.value,m(),i(s.critereId,t.target.value)}),c.appendChild(s),n.appendChild(c),l.appendChild(n)}),l.querySelectorAll("tr").forEach(e=>{let t=a.value.toLowerCase(),n=r.value.toLowerCase(),l=""===t||e.querySelector("td:first-child").textContent.toLowerCase()===t,o=""===n||e.querySelector("select").value.toLowerCase()===n;e.style.display=l&&o?"table-row":"none"})}s.addEventListener("click",function(){localStorage.clear(),alert("localStorage has been cleared!")}),d=c();let u=document.createElement("tr"),h=document.createElement("th");h.className="column1",h.textContent="Th\xe9matique",h.addEventListener("click",()=>{e.criteres.sort((e,t)=>e.thematique.localeCompare(t.thematique)),p()}),u.appendChild(h);let C=document.createElement("th");C.className="column2",C.textContent="Crit\xe8re",C.addEventListener("click",()=>{e.criteres.sort((e,t)=>e.critere.localeCompare(t.critere)),p()}),u.appendChild(C);let E=document.createElement("th");E.className="column3",E.textContent="\xc9tat",E.addEventListener("click",()=>{e.criteres.sort((e,t)=>{let n=["conforme","en cours de d\xe9ploiement","non conforme","non applicable","a definir",];return n.indexOf(e.etat)-n.indexOf(t.etat)}),p()}),u.appendChild(E),n.appendChild(u),e.criteres.forEach(e=>{let t=document.createElement("tr"),n=document.createElement("td");n.className="column1",n.textContent=e.thematique,t.appendChild(n);let r=document.createElement("td");r.className="column2",r.textContent=e.critere,t.appendChild(r);let c=document.createElement("td");c.className="column3";let s=document.createElement("select");if(s.name=`select-${e.id}`,o.forEach(e=>{let t=document.createElement("option");t.value=e,t.textContent=e,t.selected=!0,s.appendChild(t)}),s.value=null==tabVal?"a definir":tabVal[e.id],s.critereId=e.id,s.addEventListener("change",t=>{d[e.id]=s.value,m(),p(),i(s.critereId,t.target.value)}),c.appendChild(s),t.appendChild(c),l.appendChild(t),!a.querySelector(`option[value="${e.thematique}"]`)){let u=document.createElement("option");u.value=e.thematique,u.textContent=e.thematique,a.appendChild(u)}}),t.appendChild(n),t.appendChild(l),document.body.appendChild(t),p(),m(),document.getElementById("exportButton").addEventListener("click",function e(){let t=document.getElementById("url").value,n=new window.jspdf.jsPDF;n.text("Liste des crit\xe8res d'\xe9coconception de services num\xe9riques",20,20),n.setFontSize(16);let l=`\xc9valuation de Conformit\xe9 - ${t}`;console.log("Titre:",l),n.text(l,20,10);let a=m(),r=new Date,o=r.toLocaleDateString("fr-FR"),d=`Date : ${o}`;n.text(d,20,30),n.text(`Score de Conformit\xe9 : ${a}`,n.internal.pageSize.width-80,30);let i=document.querySelectorAll("#table-container tbody tr"),c=[];i.forEach(e=>{let t=e.querySelector("td:first-child").textContent,n=e.querySelector("td:nth-child(2)").textContent,l=e.querySelector("select").value;c.push([t,n,l])}),n.autoTable({startY:40,head:[["Th\xe8me","Crit\xe8re","\xc9tat"]],body:c}),n.save("exported_text.pdf")}),t.appendChild(n),t.appendChild(l),document.getElementById("table-container").appendChild(t),[a,r].forEach(e=>{e.addEventListener("change",()=>{p(),m()})}),m()}},xhr.send(),document.getElementById("submitUrl").addEventListener("click",function(){let e=document.getElementById("url").value;localStorage.setItem("enteredUrl",e),window.location.hash="#table-container",document.getElementById("main-header").classList.add("hidden"),document.getElementById("displayedUrl").textContent=e});